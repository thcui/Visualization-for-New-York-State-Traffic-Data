# Results




```{r echo=FALSE}
library(tidyverse)
library(hash)
library(RColorBrewer)
library(grid)
library(gridExtra)
library(GGally)
library(parcoords)
library(plotly)
library(scales) 
```


```{r echo=FALSE}
#Load the data, to use the data: data[[year]], where year is str.
data<-hash()
data[['2018']]<-read_csv('data/2018.csv')
data[['2019']]<-read_csv('data/2019.csv')
data[['2020']]<-read_csv('data/2020.csv')


```

## Overview for New York State
### The overall trend of the average count per hour per street from 2018 to 2020
```{r echo=FALSE}
#Line chart, Overall

data_2018_line_chart<-data[['2018']]%>%pivot_longer(cols=c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"), 
                                                    names_to='Time Interval',
                                                    values_to='count_per_hour',)%>%
   mutate(Year=as.character(YEAR))%>%
  group_by(Year, MONTH) %>% summarize(
  Total_count = sum(count_per_hour, na.rm = TRUE),
  Number_of_test_hours = sum(!is.na(count_per_hour))
) %>% mutate(Average_count_per_hour = Total_count / Number_of_test_hours)

data_2019_line_chart<-data[['2019']]%>%pivot_longer(cols=c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"), 
                                                    names_to='Time Interval',
                                                    values_to='count_per_hour',)%>%
   mutate(Year=as.character(YEAR))%>%
  group_by(Year, MONTH) %>% summarize(
  Total_count = sum(count_per_hour, na.rm = TRUE),
  Number_of_test_hours = sum(!is.na(count_per_hour))
) %>% mutate(Average_count_per_hour = Total_count / Number_of_test_hours)

data_2020_line_chart<-data[['2020']]%>%pivot_longer(cols=c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"),
                                                    names_to='Time Interval',
                                                    values_to='count_per_hour',)%>%
  mutate(Year=as.character(YEAR))%>%
  group_by(Year, MONTH) %>% summarize(
  Total_count = sum(count_per_hour, na.rm = TRUE),
  Number_of_test_hours = sum(!is.na(count_per_hour))
) %>% mutate(Average_count_per_hour = Total_count / Number_of_test_hours)
  
p <-
  ggplot(mapping = aes(
    color =Year,
    x = MONTH,
    y = Average_count_per_hour,
    group = 1,
    text = paste('</br>Year: ', Year,
                 '</br>Month: ', MONTH,
                 '</br>Average count per hour per street: ', Average_count_per_hour)
                    
  )) + geom_line(data = data_2018_line_chart) + geom_line(data = data_2019_line_chart) +
  geom_line(data = data_2020_line_chart) + scale_x_continuous(breaks = 1:12, labels =
                                                                1:12) + xlab("Month") + ylab("Average count per hour for each street") +
  scale_colour_manual(values = c("red", "blue", "darkgreen"))+theme_bw()
ggplotly(p,tooltip = "text")
```

## The busiest streets in New York State from 2018 to 2020

```{r echo=FALSE,fig.width=10,fig.height=20}

prepare_data_bar_chart<-function(year){

d<-data[[year]]%>%pivot_longer(cols=c('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24'),names_to="Time_Interval",values_to = "Count")%>%
  group_by(YEAR,REGION,SPECIFIC_RECORDER_PLACEMENT)%>%
  summarize(Total_Count=sum(Count,na.rm=TRUE),Number_of_tests=sum(!is.na(Count)))%>%
  mutate(Average_Count=Total_Count/Number_of_tests,REGION=recode(REGION, 
                '01' = 'Albany', 
                '02' = 'Utica',
                '03' = 'Syracuse',
                '04' = 'Rochester',
                '05' = 'Buffalo',
                '06' = 'Hornell',
                '07' = 'Watertown',
                '08' = 'Poughkeepsie',
                '09'='Binghamton',
                '10'='Hauppauge',
                '11' = 'New York City'))%>%ungroup()
}

bar_chart_data <-
  bind_rows(
    prepare_data_bar_chart('2018') %>% top_n(n = 15, wt = Average_Count),
    prepare_data_bar_chart('2019') %>% top_n(n = 15, wt = Average_Count),
    prepare_data_bar_chart('2020') %>% top_n(n = 15, wt = Average_Count)
  )
ggplot(bar_chart_data, aes(
  x = reorder(SPECIFIC_RECORDER_PLACEMENT,-Average_Count),
  y = Average_Count,
  fill = REGION
)) + geom_col() + theme(axis.text.x = element_text(
  angle = 90,
  vjust = 0.5,
  hjust = 1
)) + ggtitle('The top 15 busiest streets in New York State in 2018,2019 and 2020') + facet_wrap( ~
                                                                                     YEAR, ncol = 1, scales = "free_x")


```
From the plots above, we can see there are more busy streets from New York City(NYC) from 2018 to 2020, and it turns out that the 15 busiest streets are all from NYC on 2020. This suggest us that there may be something different between NYC and other counties, and we should take a closer look to NYC.

## Closer Look at the New York City
```{r echo=FALSE}

prepare_data_heat_map<-function(region_code,year){

  #relevel DAY_OF_WEEK
  data[[year]]$DAY_OF_WEEK <-
    fct_relevel(
      data[[year]]$DAY_OF_WEEK,
      c(
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
        "Sunday"
      )
    )
  
  
  regional_count_only<-data[[year]]%>%
    filter(REGION==region_code)%>%
    pivot_longer(cols=c('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24'),names_to="Time_Interval",values_to = "Count")%>%
    group_by(Time_Interval, DAY_OF_WEEK) %>%
    summarize(Total_Count = sum(Count, na.rm = TRUE),
              Number_of_tests = sum(!is.na(Count))) %>% 
    mutate(
      Average_Count = Total_Count / Number_of_tests,
      Category = cut(
        Average_Count,
        right = TRUE,
        breaks = c(0, 75, 150, 225, 300, 375, 450, 525, Inf)
      )
    )
  

  #relevel Time_Interval
  regional_count_only$Time_Interval<-fct_rev(fct_relevel(regional_count_only$Time_Interval,c('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24')))
  return(regional_count_only)
}

```

```{r echo=FALSE,fig.width=20,fig.height=10}
#NYC,2018-2020,HEATMAP
nyc_2018_count_only <- prepare_data_heat_map('11', '2018')
nyc_2019_count_only <- prepare_data_heat_map('11', '2019')
nyc_2020_count_only <- prepare_data_heat_map('11', '2020')

colors <- brewer.pal(8, "YlOrBr")
heatmap_nyc_2018 <-
  ggplot(nyc_2018_count_only,
         aes(DAY_OF_WEEK, Time_Interval, fill = Category, label = Average_Count)) +
  geom_tile(color = "white") + scale_fill_manual(values = colors) + ggtitle('2018') +
  labs(fill = "Average Count Per Hour")

heatmap_nyc_2019 <-
  ggplot(nyc_2019_count_only,
         aes(DAY_OF_WEEK, Time_Interval, fill = Category,label = Average_Count)) +
  geom_tile(color = "white") + scale_fill_manual(values = colors) + ggtitle('2019') +
  labs(fill = "Average Count Per Hour")

heatmap_nyc_2020 <-
  ggplot(nyc_2020_count_only,
         aes(DAY_OF_WEEK, Time_Interval, fill = Category,label = Average_Count)) +
  geom_tile(color = "white") + scale_fill_manual(values = colors) + ggtitle('2020') +
  labs(fill = "Average Count Per Hour")

heat_maps<-grid.arrange(
  heatmap_nyc_2018,
  heatmap_nyc_2019,
  heatmap_nyc_2020,
  ncol = 3,
  nrow = 1,
  top = textGrob(
    'Average count for New York City from 2018 to 2020',
    gp = gpar(fontsize = 30)
  )
)
  
```
